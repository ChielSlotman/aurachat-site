<!doctype html>
<html lang="en" data-active="success">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AuraSync Premium Activated</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/logo/icon_only.png">
  <link rel="canonical" href="https://aurasync.info/success/">
  <meta name="robots" content="index,follow">
  <meta property="og:title" content="AuraSync Premium" />
  <meta property="og:description" content="Unlock floating avatars and pro features." />
  <meta property="og:url" content="https://aurasync.info/success/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <link rel="stylesheet" href="/assets/site.css">
  <link rel="stylesheet" href="/styles.css">
  <script src="/partials/include.js" defer></script>
</head>
<body>
  <div data-include="/partials/header.html"></div>
  <main>
    <section class="hero-gradient">
      <div class="container py-16 md:py-24">
        <div class="card p-6 md:p-8 max-w-2xl mx-auto">
          <h1 class="text-3xl font-semibold text-slate-100">AuraSync Premium</h1>
          <p id="lead" class="mt-2 text-slate-400" aria-live="polite">Checking your payment…</p>
          <div id="spinner" role="status" class="mt-4 hidden">⏳</div>
          <div id="success" class="hidden mt-6">
            <div class="text-green-400 text-4xl">✓</div>
            <h2 class="text-2xl text-slate-100 mt-2">Premium Activated</h2>
            <p class="mt-2 text-slate-300">We emailed the code to <strong id="emailOut"></strong>.</p>
            <div class="mt-4 flex gap-2 items-center">
              <input id="code" readonly class="flex-1 rounded-xl bg-black/40 border border-white/10 px-3 py-2" aria-label="Activation code">
              <button id="copy" class="btn-secondary px-4 py-2 rounded-lg">Copy</button>
            </div>
            <div class="mt-6 flex flex-wrap gap-3">
              <a href="#" class="btn-secondary px-4 py-2 rounded-lg" rel="noopener noreferrer">Open the extension</a>
              <button id="open-portal" class="btn-secondary px-4 py-2 rounded-lg">Manage billing</button>
            </div>
          </div>
          <div id="error" class="hidden mt-6">
            <p class="text-red-400">We could not verify your purchase yet. Please wait 30 seconds and refresh. If it persists, contact support.</p>
            <button id="retry" class="btn-secondary mt-3 px-4 py-2 rounded-lg">Retry</button>
          </div>
        </div>
      </div>
    </section>
  </main>
  <div data-include="/partials/footer.html"></div>

<script>
function getParam(name){try{const u=new URL(window.location.href);return u.searchParams.get(name);}catch{return null}}
function el(id){return document.getElementById(id)}
function showSpinner(on){el('spinner').classList.toggle('hidden',!on)}
function setLead(txt){el('lead').textContent=txt}
// Progressive status helper to reassure users while waiting
const PROGRESS_SCHEDULE = [
  { t: 0, msg: 'Checking your payment…' },
  { t: 5000, msg: 'Still working… this can take 10–30 seconds.' },
  { t: 15000, msg: 'Servers can be busy. Please keep this tab open.' },
  { t: 30000, msg: 'Almost there. It can take up to 1–2 minutes at peak times.' },
  { t: 60000, msg: 'Thanks for waiting. Most activations finish within 2 minutes.' },
  { t: 120000, msg: 'If this takes more than 3–5 minutes, refresh or contact support.' }
];
let progressTimers = [];
function startProgress(){
  clearProgress();
  progressTimers = PROGRESS_SCHEDULE.map(({t,msg})=>setTimeout(()=>setLead(msg), t));
}
function clearProgress(){
  progressTimers.forEach(clearTimeout); progressTimers=[];
}
async function activate(){
  const sid=getParam('session_id');
  if(!sid){
    setLead('We could not detect your session.');
    el('error').classList.remove('hidden');
    return;
  }
  showSpinner(true);
  startProgress();
  try{
    const res=await fetch('https://api.aurasync.info/activate',{method:'POST',credentials:'omit',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sid})});
    const data=await res.json().catch(()=>({}));
    if(!res.ok||!data||!data.code){
      throw new Error(data?.message||'not_verified');
    }
    const code=(data.code||'').trim();
    const email=(data.email||'').trim();
    el('success').classList.remove('hidden');
    el('error').classList.add('hidden');
    el('code').value = code;
    el('emailOut').textContent = email;
    clearProgress();
    setLead('Here is your activation code');
  }catch(e){
    clearProgress();
    setLead('We could not verify your purchase yet. Please wait a bit and retry.');
    el('success').classList.add('hidden');
    el('error').classList.remove('hidden');
  }finally{
    showSpinner(false);
  }
}
activate();
el('copy')?.addEventListener('click',()=>{const i=el('code');i.select();document.execCommand('copy');});
el('retry')?.addEventListener('click', activate);
el('open-portal')?.addEventListener('click', async()=>{
  const customer_id = window.localStorage.getItem('stripe_customer_id')||'';
  if(!customer_id){alert('Use your Stripe receipt to manage billing.');return;}
  try{const r=await fetch('https://api.aurasync.info/billing-portal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customer_id})});const d=await r.json();if(d?.url){window.location.href=d.url}else alert('Portal unavailable')}catch{alert('Portal unavailable')}
});
</script>
</body>
</html>
